/*********************************************************************************************************//**
* @file kern_time.c
* @author  
*    JangHo,Yoo
* @date 
*   2012.10.15 
* @brief 
*   이 파일은 시스템 시간관리를 위한 tick에 대한 함수들을 기술한다.\n
*   1. Tick 타이머 초기화\n
*   2. Tick 타이머 시작, 정지\n
*   3. Tick 지연함수\n
*   4. 시간관리를 위한 flag
* @attention
*   Tick 타이머의 시간은 최소 1ms에서 10ms까지의 설정을 추천한다.
*************************************************************************************************************/

/*************************************************************************************************************
* INCLUDE FILES
*************************************************************************************************************/
#include "kernel.h"

/*************************************************************************************************************
* LOCAL DEFINES
*************************************************************************************************************/
#define TICK_4MS                           4     /**< 4ms Tick에 대한 카운터 상수                     */
#define TICK_10MS                          10    /**< 10ms Tick에 대한 카운터 상수                  */
#define TICK_100MS                         100   /**< 100ms Tick에 대한 카운터 상수               */
#define TICK_1SEC                          1000  /**< 1sec Tick에 대한 카운터 상수                  */

/*************************************************************************************************************
* LOCAL CONSTANTS
*************************************************************************************************************/

/*************************************************************************************************************
* LOCAL DATA TYPES
*************************************************************************************************************/

/*************************************************************************************************************
* LOCAL TABLES
*************************************************************************************************************/

/*************************************************************************************************************
* LOCAL GLOBAL VARIABLES
*************************************************************************************************************/
static volatile uint32    gTickCount;                  /**< Tick Delay Counter     */
static volatile var_flag  gTick4msFlag;                /**< Tick 4ms Flag          */
static volatile var_flag  gTick10msFlag;               /**< Tick 10ms Flag         */
static volatile var_flag  gTick100msFlag;              /**< Tick 100ms Flag        */
static volatile var_flag  gTick1secFlag;               /**< Tick 1sec Flag         */

static uint32 gTick4msCnt;
static uint32 gTick10msCnt;
static uint32 gTick100msCnt;
static uint32 gTick1secCnt;

/*************************************************************************************************************
* LOCAL FUNCTION PROTOTYPES
*************************************************************************************************************/
static void InitTickTimerVar(void);

/*************************************************************************************************************
* LOCAL CONFIGURATION ERRORS
*************************************************************************************************************/

/*************************************************************************************************************
**************************************************************************************************************
* LOCAL FUNCTIONS
**************************************************************************************************************
*************************************************************************************************************/
static void InitTickTimerVar(void)
{
	gTickCount      = 0;
	gTick4msFlag    = 0;
	gTick10msFlag   = 0;
	gTick100msFlag  = 0;
	gTick1secFlag   = 0;
	
	gTick4msCnt     = 0;
	gTick10msCnt    = 0;
	gTick100msCnt   = 0;
	gTick1secCnt    = 0;
} /* InitTickTimerVar */

/*************************************************************************************************************
**************************************************************************************************************
* GLOBAL FUNCTIONS
**************************************************************************************************************
*************************************************************************************************************/
/*********************************************************************************************************//**
* @param[in]
* @param[out]
* @retval none
* @brief 
*   Tick timer를 초기화 한다.
*************************************************************************************************************/
void InitTickTimerConfig(void)
{
	// Initialization of variables
	InitTickTimerVar();

	//TODO : Add your tick timer initialization code

} /* InitTickTimer */


/*********************************************************************************************************//**
* @param[in]
* @param[out]
* @retval none
* @brief 
*  Tick timer를 시작한다.
*************************************************************************************************************/
void StartTickTimer(void)
{	//TODO : Add your tick timer start code

} /* StartTickTimer */


/*********************************************************************************************************//**
* @param[in]
* @param[out]
* @retval 
* @brief 
*  Tick timer를 중지한다.
*************************************************************************************************************/
void StopTickTimer(void)
{
	//TODO : Add your tick timer stop code

} /* StopTickTimer */

/*********************************************************************************************************//**
* @param[in] n_tick : 지연하고자 하는 tick 갯수.
* @param[out]
* @retval none
* @brief 
*  입력된 tick의 갯수만큼 CPU를 지연시킨다.
*************************************************************************************************************/
void CPU_MEM_ISPM WaitTickCount(volatile uint32 n_tick)
{
	gTickCount = n_tick;
	while (gTickCount > 0)
	{
		// Wait until tick count reach to zero.
	}
} /* WaitTickCount */

/*********************************************************************************************************//**
* @param[in]
* @param[out]
* @retval  none
* @brief 
*   이 함수는 시스템 tick timer의 User 인터럽트를 서비스한다.
*   1. Tick 지연 카운터
*   2. Tick 분할 task를 위한 시간 flag
*   3. 시스템 time management를 위한 flag
*************************************************************************************************************/
void CPU_MEM_ISPM TickIsr(void)
{
	if (gTickCount > 0)
	{
		gTickCount--;
	}

	if ((gTick4msFlag == 0) && (gTick4msCnt++ >= TICK_4MS))
	{
		gTick4msCnt  = 0;
		gTick4msFlag = 1;
	}

	if ((gTick10msFlag == 0) && (gTick10msCnt++ >= TICK_10MS))
	{
		gTick10msCnt  = 0;
		gTick10msFlag = 1;
	}

	if ((gTick100msFlag == 0) && (gTick100msCnt++ >= TICK_100MS))
	{ 
		gTick100msCnt  = 0;
	 	gTick100msFlag = 1;
	}

	if ((gTick1secFlag == 0) && (gTick1secCnt++ >= TICK_1SEC))
	{
		gTick1secCnt  = 0;
		gTick1secFlag = 1;
	}		

	//TODO : Add user tick interrupt service code

} /* KernTickTimeIsr */

#if USE_TICK_FLAG_C_FUNC > 0
/*********************************************************************************************************//**
* @param[in]
* @param[out]
* @retval 
*  Tick time 4msec state.
*  1 = Tick time is reached 4ms
*  0 = Tick counting
* @brief 
*  4ms tick time
*************************************************************************************************************/
var_flag GetTick4msFlag(void)
{
	return gTick4msFlag;
} /* GetTick4msFlag */

/*********************************************************************************************************//**
* @param[in]
* @param[out]
* @retval 
*  1 = Tick time is reached 10ms
*  0 = Tick counting
* @brief 
*************************************************************************************************************/
var_flag GetTick10msFlag(void)
{
	return gTick10msFlag;
} /* GetTick10msFlag */

/*********************************************************************************************************//**
* @param[in]
* @param[out]
* @retval 
*  1 = Tick time is reached 100ms
*  0 = Tick counting
* @brief 
*************************************************************************************************************/
var_flag GetTick100msFlag(void)
{
	return gTick100msFlag;
} /* GetTick100msFlag */

/*********************************************************************************************************//**
* @param[in]
* @param[out]
* @retval 
*  1 = Tick time is reached 1sec
*  0 = Tick counting
* @brief 
*************************************************************************************************************/
var_flag GetTick1secFlag(void)
{
	return gTick1secFlag;
} /* GetTick100msFlag */
#endif
/********************************************** END OF FILE *************************************************/

